{% extends "base.html" %}
{% block content %}
<h1>Iniciar sesión</h1>
<form id="f" class="row" style="gap:8px;flex-wrap:wrap;max-width:520px">
  <input name="username" placeholder="Usuario o email" required>
  <input name="password" placeholder="Password" type="password" required>
  <button class="btn" type="submit">Entrar</button>
</form>
<p id="msg" style="margin-top:8px;color:#555"></p>
<script>
function getCsrf(){const n='csrftoken=';return (document.cookie.split(';').map(c=>c.trim()).find(c=>c.startsWith(n))||'').slice(n.length)||''}
const F=document.getElementById('f'); const MSG=document.getElementById('msg');

F.addEventListener('submit', async (e)=>{
  e.preventDefault();
  MSG.textContent='Verificando...';
  const fd = new FormData(F);
  const payload = { username: fd.get('username'), password: fd.get('password') };
  try{
    const r = await fetch('/api/auth/token/login/', {
      method:'POST',
      headers:{'Content-Type':'application/json','X-CSRFToken':getCsrf()},
      body: JSON.stringify(payload)
    });
    const data = await r.json();
    if(!r.ok) throw new Error(data?.detail || 'Credenciales inválidas');
    GAON_AUTH.setToken(data.token);
    GAON_UI.toast('¡Bienvenido!');
    location.href='/account/';
  }catch(err){
    MSG.textContent='Error: '+err.message;
    GAON_UI.toast('No pudimos iniciar sesión', 'err', err.message);
  }
});
</script>
{% endblock %}
