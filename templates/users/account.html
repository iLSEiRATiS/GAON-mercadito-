{% extends "base.html" %}
{% block title %}Mi cuenta — GAON{% endblock %}

{% block content %}
<section class="section">
  <h1 style="margin:0 0 10px">Mi cuenta</h1>

  <div id="card" class="card pad" style="max-width:760px"></div>

  <h2 style="margin:22px 0 10px">Mis productos</h2>
  <div id="my-products" class="grid" style="grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:14px"></div>

  <div id="my-actions" class="row" style="gap:8px;margin-top:10px;display:none">
    <a class="btn" href="/products/manage/new/">Crear producto</a>
    <a id="btn-manage" class="btn outline" href="/products/manage/" style="display:none">Ver todos (gestión)</a>
  </div>

  <h2 style="margin:22px 0 10px">Mis pedidos</h2>
  <div class="card pad text-muted">Próximamente: aquí listaremos tus órdenes.</div>
</section>

<script>
(function(){
  const PH = '/static/img/placeholder.png';
  const card = document.getElementById('card');
  const root = document.getElementById('my-products');
  const actions = document.getElementById('my-actions');

  function needLogin(){
    card.innerHTML = `
      <p>Necesitás iniciar sesión.</p>
      <div class="row" style="gap:8px;margin-top:8px">
        <a class="btn" href="/login/">Ir a Login</a>
        <a class="btn outline" href="/signup/">Crear cuenta</a>
      </div>`;
  }

  async function loadMyProducts(){
    if (!root) return;
    try{
      const r = await fetch('/api/products/?mine=1', {
        headers: { ...(window.GAON_AUTH?.authHeader?.()||{}) },
        credentials: 'same-origin'
      });
      const data  = await r.json().catch(()=>({results:[]}));
      const items = Array.isArray(data) ? data : (Array.isArray(data.results) ? data.results : []);

      if (!items.length){
        root.innerHTML = `<div class="card pad">No tenés productos creados aún.</div>`;
        if (actions) actions.style.display = 'flex';
        return;
      }

      root.innerHTML = items.map(p=>{
        const img    = p.imagen_url || PH;
        const nombre = p.nombre || 'Producto';
        const precio = Number(p.precio);
        const fecha  = (p.creado_en||'').slice(0,10);
        return `
          <div class="card">
            <div class="imgbox" style="height:200px"><img src="${img}" alt="${nombre}" onerror="this.src='${PH}'"></div>
            <div class="pad">
              <div class="row" style="justify-content:space-between">
                <div class="price">${Number.isFinite(precio) ? precio.toLocaleString('es-AR',{style:'currency',currency:'ARS'}) : '-'}</div>
                <small class="text-muted">${fecha}</small>
              </div>
              <h3 style="margin:.4rem 0">${nombre}</h3>
              <div class="row" style="gap:8px;flex-wrap:wrap">
                <a class="btn outline" href="/products/${p.id}/">Ver</a>
                <a class="btn outline" href="/products/manage/${p.id}/edit/">Editar</a>
                <a class="btn outline" href="/products/manage/${p.id}/delete/">Borrar</a>
              </div>
            </div>
          </div>`;
      }).join('');

      if (actions) actions.style.display = 'flex';
    }catch(err){
      root.innerHTML = `<div class="card pad">No pudimos cargar tus productos.</div>`;
      if (actions) actions.style.display = 'flex';
    }
  }

  async function start(){
    // Soportar dos modos de autenticación: Token en localStorage o sesión Django (cookie).
    let data;
    if (window.GAON_AUTH?.hasToken?.()){
      const r = await fetch('/api/auth/me/', { headers: { ...GAON_AUTH.authHeader() }});
      data = await r.json();
      if (!r.ok) { needLogin(); return; }
    } else {
      // Intentar autenticar por sesión (cookie)
      try{
        const r = await fetch('/api/auth/me/', { credentials: 'same-origin' });
        data = await r.json();
        if (!r.ok) { needLogin(); return; }
      }catch(_){ needLogin(); return; }
    }

    card.innerHTML = `
      <div class="row" style="justify-content:space-between; gap:8px; flex-wrap:wrap">
        <div>
          <strong>${data.first_name||''} ${data.last_name||''}</strong><br>
          <small class="text-muted">${data.email||''}</small>
        </div>
      </div>
      <hr style="margin:12px 0">
      <div class="row" style="gap:24px;flex-wrap:wrap">
        <div><b>Usuario:</b> ${data.username}</div>
        <div><b>Teléfono:</b> ${data.telefono||'-'}</div>
        <div><b>Rol:</b> ${data.rol || (data.is_staff ? 'staff' : 'cliente')}</div>
      </div>
      <div class="row" style="gap:8px;margin-top:10px">
        <a class="btn outline" href="/account/edit/">Editar perfil</a>
      </div>
    `;

    if (actions) actions.style.display = 'flex';
  const isStaff = !!data.is_staff || !!data.is_superuser || /^(staff|admin)$/i.test(String(data.rol||''));
    const btnManage = document.getElementById('btn-manage');
    if (btnManage) btnManage.style.display = isStaff ? '' : 'none';

    await loadMyProducts();
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    if (window.GAON_AUTH) return start();
    const iv = setInterval(()=>{ if (window.GAON_AUTH){ clearInterval(iv); start(); } }, 50);
  });
})();
</script>
{% endblock %}
