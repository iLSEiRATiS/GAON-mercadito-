{% extends "base.html" %}
{% block title %}Mi cuenta — GAON{% endblock %}

{% block content %}
<section class="section">
  <h1 style="margin:0 0 10px">Mi cuenta</h1>

  <div id="card" class="card pad" style="max-width:760px"></div>

  <h2 style="margin:22px 0 10px">Mis productos</h2>
  <div id="my-products" class="grid" style="grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:14px"></div>

  <div id="my-actions" class="row" style="gap:8px;margin-top:10px;display:none">
    <a class="btn" href="/products/manage/new/">Crear producto</a>
    <a id="btn-manage" class="btn outline" href="/products/manage/" style="display:none">Ver todos (gestión)</a>
  </div>

  <h2 style="margin:22px 0 10px">Mis pedidos</h2>
  <div class="card pad text-muted">Próximamente: aquí listaremos tus órdenes.</div>

  <h2 style="margin:22px 0 10px">Mis publicaciones y comentarios</h2>
  <div id="my-foro-posts" class="grid" style="grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:14px"></div>
  <div id="my-foro-comments" style="margin-top:12px; display:flex;flex-direction:column;gap:12px"></div>
</section>

<script>
(function(){
  const PH = '/static/img/placeholder.png';
  const card = document.getElementById('card');
  const root = document.getElementById('my-products');
  const actions = document.getElementById('my-actions');

  function needLogin(){
    card.innerHTML = `
      <p>Necesitás iniciar sesión.</p>
      <div class="row" style="gap:8px;margin-top:8px">
        <a class="btn" href="/login/">Ir a Login</a>
        <a class="btn outline" href="/signup/">Crear cuenta</a>
      </div>`;
  }

  async function loadMyProducts(){
    if (!root) return;
    try{
      const r = await fetch('/api/products/?mine=1', {
        headers: { ...(window.GAON_AUTH?.authHeader?.()||{}) },
        credentials: 'same-origin'
      });
      const data  = await r.json().catch(()=>({results:[]}));
      const items = Array.isArray(data) ? data : (Array.isArray(data.results) ? data.results : []);

      if (!items.length){
        root.innerHTML = `<div class="card pad">No tenés productos creados aún.</div>`;
        if (actions) actions.style.display = 'flex';
        return;
      }

      root.innerHTML = items.map(p=>{
        // La API puede devolver la imagen en diferentes campos según el serializer/front: imagen, imagen_url, image_url
        const imgUrl = p.imagen || p.imagen_url || p.image_url || '';
        const nombre = p.nombre || 'Producto';
        const precio = Number(p.precio);
        const fecha  = (p.creado_en||'').slice(0,10);

        const imgHtml = imgUrl ?
          `<div class="imgbox" style="height:200px;background:#f3f4f6;display:flex;align-items:center;justify-content:center;overflow:hidden"><img src="${imgUrl}" alt="${nombre}" style="width:100%;height:100%;object-fit:cover;display:block" onerror="this.src='${PH}'"></div>` :
          `<div class="imgbox" style="height:200px;background:#f3f4f6;display:flex;align-items:center;justify-content:center;overflow:hidden"><div class="ph" aria-label="Sin imagen" style="display:flex;flex-direction:column;align-items:center;gap:6px;color:#9aa0a6"><svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" style="width:36px;height:36px;opacity:.7"><path d=\"M19 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2Zm0 2v9.586l-3.293-3.293a1 1 0 0 0-1.414 0L10 15.586l-2.293-2.293a1 1 0 0 0-1.414 0L5 14.586V5h14ZM5 19v-2.586l2.293-2.293 2.293 2.293a1 1 0 0 0 1.414 0L15.586 12 19 15.414V19H5Zm4-9a2 2 0 1 0 0-4 2 2 0 0 0 0 4Z\"></path></svg><small>Sin imagen</small></div></div>`;

        return `
          <div class="card">
            ${imgHtml}
            <div class="pad">
              <div class="row" style="justify-content:space-between">
                <div class="price">${Number.isFinite(precio) ? precio.toLocaleString('es-AR',{style:'currency',currency:'ARS'}) : '-'}</div>
                <small class="text-muted">${fecha}</small>
              </div>
              <h3 style="margin:.4rem 0">${nombre}</h3>
              <div class="row" style="gap:8px;flex-wrap:wrap">
                <a class="btn outline" href="/products/${p.id}/">Ver</a>
                <a class="btn outline" href="/products/manage/${p.id}/edit/">Editar</a>
                <a class="btn outline" href="/products/manage/${p.id}/delete/">Borrar</a>
              </div>
            </div>
          </div>`;
      }).join('');

      if (actions) actions.style.display = 'flex';
    }catch(err){
      root.innerHTML = `<div class="card pad">No pudimos cargar tus productos.</div>`;
      if (actions) actions.style.display = 'flex';
    }
  }

  async function start(){
    // Soportar dos modos de autenticación: Token en localStorage o sesión Django (cookie).
    let data;
    if (window.GAON_AUTH?.hasToken?.()){
      const r = await fetch('/api/auth/me/', { headers: { ...GAON_AUTH.authHeader() }});
      data = await r.json();
      if (!r.ok) { needLogin(); return; }
    } else {
      // Intentar autenticar por sesión (cookie)
      try{
        const r = await fetch('/api/auth/me/', { credentials: 'same-origin' });
        data = await r.json();
        if (!r.ok) { needLogin(); return; }
      }catch(_){ needLogin(); return; }
    }

    card.innerHTML = `
      <div class="row" style="justify-content:space-between; gap:8px; flex-wrap:wrap">
        <div>
          <strong>${data.first_name||''} ${data.last_name||''}</strong><br>
          <small class="text-muted">${data.email||''}</small>
        </div>
      </div>
      <hr style="margin:12px 0">
      <div class="row" style="gap:24px;flex-wrap:wrap">
        <div><b>Usuario:</b> ${data.username}</div>
        <div><b>Teléfono:</b> ${data.telefono||'-'}</div>
        <div><b>Rol:</b> ${data.rol || (data.is_staff ? 'staff' : 'cliente')}</div>
      </div>
      <div class="row" style="gap:8px;margin-top:10px">
        <a class="btn outline" href="/account/edit/">Editar perfil</a>
      </div>
    `;

    if (actions) actions.style.display = 'flex';
  const isStaff = !!data.is_staff || !!data.is_superuser || /^(staff|admin)$/i.test(String(data.rol||''));
    const btnManage = document.getElementById('btn-manage');
    if (btnManage) btnManage.style.display = isStaff ? '' : 'none';

    await loadMyProducts();
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    if (window.GAON_AUTH) return start();
    const iv = setInterval(()=>{ if (window.GAON_AUTH){ clearInterval(iv); start(); } }, 50);
  });
})();
</script>
<script>
// ===== Cargar Mis publicaciones y comentarios (Foro) =====
(function(){
  const postsRoot = document.getElementById('my-foro-posts');
  const commentsRoot = document.getElementById('my-foro-comments');

  if (!postsRoot || !commentsRoot) return;

  async function fetchJSON(url){
    try{
      const headers = window.GAON_AUTH?.hasToken?.() ? {...window.GAON_AUTH.authHeader()} : {};
      const opts = window.GAON_AUTH?.hasToken?.() ? { headers } : { credentials: 'same-origin' };
      const r = await fetch(url, opts);
      if(!r.ok) return [];
      return await r.json().catch(()=>[]);
    }catch(_){ return []; }
  }

  async function loadMyPosts(){
    const data = await fetchJSON('/api/foro/mine/posts/');
    const items = Array.isArray(data) ? data : (data.results || []);
    if(!items.length){ postsRoot.innerHTML = '<div class="card pad">No tenés publicaciones aún.</div>'; return; }
    postsRoot.innerHTML = items.map(p=>{
      return `
        <div class="card pad">
          <h3 style="margin:0 0 8px">${escapeHtml(p.titulo)}</h3>
          <div class="text-muted" style="font-size:.9rem">${escapeHtml(p.autor)} · ${ (p.creado_en||'').slice(0,16) }</div>
          <p style="margin-top:8px">${escapeHtml((p.contenido||'').slice(0,180))}</p>
          <div class="row" style="gap:8px;margin-top:8px;flex-wrap:wrap">
            <a class="btn outline" href="/foro/post/${p.id}/">Ver</a>
            <a class="btn outline" href="/foro/post/${p.id}/edit/">Editar</a>
            <a class="btn outline" href="/foro/post/${p.id}/delete/">Borrar</a>
          </div>
        </div>`;
    }).join('');
    // Ahora el borrado se realiza desde la página de confirmación: /foro/post/<id>/delete/
  }

  async function loadMyComments(){
    const data = await fetchJSON('/api/foro/mine/comentarios/');
    const items = Array.isArray(data) ? data : (data.results || []);
    if(!items.length){ commentsRoot.innerHTML = '<div class="card pad">No tenés comentarios aún.</div>'; return; }
    commentsRoot.innerHTML = items.map(c=>{
      return `
        <div class="card pad">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>${escapeHtml(c.autor)}</strong> en <a href="/products/${c.producto}/">Producto</a></div>
            <small class="text-muted">${(c.creado_en||'').slice(0,16)}</small>
          </div>
          <div style="margin-top:8px; white-space:pre-wrap">${escapeHtml(c.texto)}</div>
          <div class="row" style="gap:8px;margin-top:8px">
            <a class="btn outline" href="/foro/comentario/${c.id}/edit/">Editar</a>
            <a class="btn outline" href="/foro/comentario/${c.id}/delete/">Borrar</a>
          </div>
        </div>`;
    }).join('');
    // Ahora el borrado se realiza en la página de confirmación: /foro/comentario/<id>/delete/
  }

  function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, function(m){return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m];}); }

  document.addEventListener('DOMContentLoaded', ()=>{
    // give time for auth initialization
    setTimeout(()=>{ loadMyPosts(); loadMyComments(); }, 300);
  });
})();
</script>
{% endblock %}
