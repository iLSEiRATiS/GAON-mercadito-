{% extends "base.html" %}
{% block content %}
<h1>Mi cuenta</h1>
<div id="card" class="card pad" style="max-width:720px"></div>

<h2 style="margin-top:24px">Mis pedidos</h2>
<p>Próximamente: aquí listaremos tus órdenes (Semana 10).</p>

<script>
const card=document.getElementById('card');

function needLogin(){
  card.innerHTML = `
    <p>Necesitás iniciar sesión.</p>
    <div class="row" style="gap:8px;margin-top:8px">
      <a class="btn" href="/login/">Ir a Login</a>
      <a class="btn outline" href="/signup/">Crear cuenta</a>
    </div>`;
}

(async ()=>{
  if(!GAON_AUTH.hasToken()){ needLogin(); return; }
  try{
    const r= await fetch('/api/auth/me/', { headers: { ...GAON_AUTH.authHeader() }});
    const data = await r.json();
    if(!r.ok) throw new Error(data?.detail || 'No autorizado');
    card.innerHTML = `
      <div class="row" style="justify-content:space-between">
        <div>
          <strong>${data.first_name||''} ${data.last_name||''}</strong><br>
          <small>${data.email||''}</small>
        </div>
        <div><a class="btn outline" href="/#" id="logout-acc">Salir</a></div>
      </div>
      <hr style="margin:12px 0">
      <div class="row" style="gap:24px;flex-wrap:wrap">
        <div><b>Usuario:</b> ${data.username}</div>
        <div><b>Teléfono:</b> ${data.telefono||'-'}</div>
        <div><b>Rol:</b> ${data.rol||'cliente'}</div>
      </div>
    `;
    document.getElementById('logout-acc')?.addEventListener('click', async (e)=>{
      e.preventDefault();
      try{ await fetch('/api/auth/token/logout/', {method:'POST', headers:{...GAON_AUTH.authHeader()}});}catch(_){}
      GAON_AUTH.clearToken();
      location.href='/products/';
    });
  }catch(e){
    needLogin();
  }
})();
</script>
{% endblock %}
