{% extends "base.html" %}
{% block content %}
<h1>Crear cuenta</h1>
<form id="f" class="row" style="gap:8px;flex-wrap:wrap;max-width:680px">
  <input name="username" placeholder="Usuario" required>
  <input name="email" placeholder="Email" type="email" required>
  <input name="password" placeholder="Password" type="password" required>
  <input name="first_name" placeholder="Nombre">
  <input name="last_name" placeholder="Apellido">
  <input name="telefono" placeholder="Teléfono">
  <button class="btn" type="submit">Crear cuenta</button>
</form>
<p id="msg" style="margin-top:8px;color:#555"></p>
<script>
function getCsrf(){const n='csrftoken=';return (document.cookie.split(';').map(c=>c.trim()).find(c=>c.startsWith(n))||'').slice(n.length)||''}
const F=document.getElementById('f'); const MSG=document.getElementById('msg');

F.addEventListener('submit', async (e)=>{
  e.preventDefault();
  MSG.textContent='Creando cuenta...';
  const fd = new FormData(F);
  const payload = {
    username: fd.get('username'),
    email: fd.get('email'),
    password: fd.get('password'),
    first_name: fd.get('first_name'),
    last_name: fd.get('last_name'),
    telefono: fd.get('telefono')
  };
  try{
    const r = await fetch('/api/auth/signup/', {
      method:'POST',
      headers:{'Content-Type':'application/json','X-CSRFToken':getCsrf()},
      body: JSON.stringify(payload)
    });
    const data = await r.json();
    if(!r.ok) throw new Error(data?.detail || 'Error al registrar');
    if(data.token){
      GAON_AUTH.setToken(data.token);
      GAON_UI.toast('Cuenta creada');
      location.href='/account/';
    }else{
      GAON_UI.toast('Cuenta creada. Iniciá sesión.');
      location.href='/login/';
    }
  }catch(err){
    MSG.textContent='Error: '+err.message;
    GAON_UI.toast('No pudimos crear la cuenta', 'err', err.message);
  }
});
</script>
{% endblock %}
