<!doctype html>
<html lang="es">
{% load static %}
<head>
  <meta charset="utf-8">
  <title>GAON</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Favicon / Logo -->
  <link rel="icon" href="{% static 'gaon.ico' %}" sizes="any">
  <link rel="shortcut icon" href="{% static 'gaon.ico' %}">

  <style>
    :root{--c:#111;--a:#0a7;--b:#eee;--err:#c0392b;--ok:#16a085}
    *{box-sizing:border-box}body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial}
    header{background:#fff;border-bottom:1px solid #ddd;position:sticky;top:0;z-index:10}
    .wrap{max-width:1100px;margin:0 auto;padding:12px}
    .row{display:flex;gap:10px;align-items:center}
    a{color:inherit;text-decoration:none}
    nav a{padding:8px 10px;border-radius:10px}
    nav a:hover{background:#f5f5f5}
    .btn{background:var(--a);color:#fff;border:0;border-radius:10px;padding:10px 14px;cursor:pointer}
    .btn.outline{background:#fff;color:var(--a);border:1px solid var(--a)}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:14px;margin:16px 0}
    .card{background:#fff;border:1px solid #e8e8e8;border-radius:16px;overflow:hidden}
    .card img{width:100%;height:180px;object-fit:cover;background:#fafafa}
    .pad{padding:12px}
    .search{display:flex;flex-wrap:wrap;gap:8px;margin:14px 0}
    input,select{padding:10px;border:1px solid #ddd;border-radius:10px}
    main{min-height:60vh;background:var(--b)}
    .price{font-weight:700}
    footer{border-top:1px solid #ddd;background:#fff}
    .badge{display:inline-block;min-width:20px;height:20px;border-radius:10px;line-height:20px;text-align:center;font-size:12px;background:var(--a);color:#fff;margin-left:6px;padding:0 6px}
    #toast{position:fixed;right:16px;bottom:16px;display:flex;flex-direction:column;gap:8px;z-index:9999}
    .toast{background:#fff;border-left:6px solid var(--ok);border:1px solid #ddd;box-shadow:0 6px 20px rgba(0,0,0,.1);border-radius:8px;padding:10px 12px;min-width:240px}
    .toast.err{border-left-color:var(--err)}
    .toast small{display:block;color:#666}
  </style>
</head>
<body>
  <header>
    <div class="wrap row" style="justify-content:space-between">
      <a href="/products/" class="row" style="gap:8px;align-items:center" aria-label="Inicio GAON">
        <img src="{% static 'gaon.ico' %}" alt="GAON" style="width:24px;height:24px;display:block">
      </a>

      <nav class="row" id="nav-auth">
        <a href="/products/">Productos</a>
        <a href="/cart/">Carrito <span id="cart-count" class="badge" style="display:none">0</span></a>
        <a href="/login/" data-guest>Login</a>
        <a href="/signup/" data-guest>Crear cuenta</a>
        <a href="/account/" id="my-account" data-auth style="display:none">Mi cuenta</a>
        <a href="/#" id="logout" data-auth style="display:none">Salir</a>
      </nav>
    </div>
  </header>

  <main><div class="wrap">{% block content %}{% endblock %}</div></main>
  <footer><div class="wrap">GAON ©</div></footer>

  <div id="toast"></div>

  <script>
    // ---------- Auth helpers ----------
    const TKEY='gaon_token';
    function hasToken(){ return !!localStorage.getItem(TKEY); }
    function setToken(t){ localStorage.setItem(TKEY, t); }
    function clearToken(){ localStorage.removeItem(TKEY); }
    function authHeader(){ const t=localStorage.getItem(TKEY); return t ? {'Authorization':'Token '+t} : {}; }

    // ---------- Navbar visibility ----------
    function setupNav(){
      const authEls=[...document.querySelectorAll('[data-auth]')];
      const guestEls=[...document.querySelectorAll('[data-guest]')];
      const logged=hasToken();
      authEls.forEach(e=>e.style.display = logged ? '' : 'none');
      guestEls.forEach(e=>e.style.display = logged ? 'none' : '');
    }

    // ---------- Toasts ----------
    function showToast(msg, type='ok', sub=''){
      const wrap = document.getElementById('toast');
      if(!wrap) return;
      const div = document.createElement('div');
      div.className = 'toast'+(type==='err'?' err':'');
      div.innerHTML = `<div>${msg}</div>${sub?`<small>${sub}</small>`:''}`;
      wrap.appendChild(div);
      setTimeout(()=>{ div.remove(); }, 3500);
    }

    // ---------- Cart badge ----------
    async function refreshCartCount(){
      const badge = document.getElementById('cart-count');
      if(!badge) return;
      try{
        const r = await fetch('/api/cart/');
        if(!r.ok) throw new Error('HTTP '+r.status);
        const data = await r.json().catch(()=>({items:[]}));
        const items = Array.isArray(data.items) ? data.items : [];
        const n = items.reduce((acc,it)=>{
          const q = Number(it?.qty);
          return acc + (Number.isFinite(q) ? q : 0);
        }, 0);
        if(n>0){ badge.textContent = String(n); badge.style.display='inline-block'; }
        else{ badge.style.display='none'; }
      }catch(_e){
        // si falla la API, ocultamos el badge
        const badge = document.getElementById('cart-count');
        if (badge) badge.style.display='none';
      }
    }

    // ---------- Logout ----------
    async function logout(){
      try{
        await fetch('/api/auth/token/logout/', {method:'POST', headers:{...authHeader()}});
      }catch(_e){}
      clearToken();
      setupNav();
      await refreshCartCount();
      showToast('Sesión cerrada');
      location.href='/products/';
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      // Inicializar navbar y badge
      setupNav();
      refreshCartCount();

      // Redirección si ya está logueado y cae en login/signup
      const p = location.pathname;
      if (hasToken() && (p === '/' || p === '/login/' || p === '/signup/')) {
        location.replace('/account/');
      }

      // Bind de logout
      const btnLogout = document.getElementById('logout');
      if (btnLogout){
        btnLogout.addEventListener('click', (e)=>{ e.preventDefault(); logout(); });
      }
    });

    // Exponer utilidades globales si se quieren usar en otras páginas
    window.GAON_AUTH = { hasToken, setToken, clearToken, authHeader };
    window.GAON_CART = { refresh: refreshCartCount };
    window.GAON_UI   = { toast: showToast };
  </script>
</body>
</html>
