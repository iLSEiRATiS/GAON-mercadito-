{% extends "base.html" %}
{% block content %}
<h1>Tu carrito</h1>

<div id="cart-root"></div>

<script>
function fmt(n){
  const v = Number(n);
  if (Number.isNaN(v)) return "$0.00";
  return v.toLocaleString('es-AR', { style: 'currency', currency: 'ARS', minimumFractionDigits: 2 });
}

function getCookie(name){
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(';').shift();
}

async function api(path, method='GET', body=null){
  const headers = { 'Content-Type': 'application/json' };
  // üëâ CSRF para m√©todos no seguros
  if (method !== 'GET' && method !== 'HEAD') {
    const csrftoken = getCookie('csrftoken');
    if (csrftoken) headers['X-CSRFToken'] = csrftoken;
  }
  const opt = { method, headers, credentials: 'same-origin' };
  if (body) opt.body = JSON.stringify(body);

  const r = await fetch(path, opt);
  // opcional: lanzar si no es OK para ver errores en consola
  if (!r.ok) {
    const err = await r.text().catch(() => '');
    throw new Error(`HTTP ${r.status}: ${err}`);
  }
  return r.json();
}

async function loadCart(){
  const data = await api('/api/cart/');
  const root = document.getElementById('cart-root');

  const items = Array.isArray(data.items) ? data.items : [];

  let total = Number(data.total_price);
  if (!Number.isFinite(total)) {
    total = items.reduce((acc, it) => {
      const sub = Number(it.subtotal);
      return acc + (Number.isFinite(sub) ? sub : 0);
    }, 0);
  }

  if (!items.length){
    root.innerHTML = `
      <p>Tu carrito est√° vac√≠o.</p>
      <a class="btn outline" href="/products/">Seguir comprando</a>
    `;
    window.GAON_CART?.refresh?.();
    return;
  }

  const rows = items.map(it => {
    const p = it.product || {};
    const img = p.imagen_url || it.image || 'https://via.placeholder.com/120x120?text=GAON';
    const name = p.nombre || it.name || 'Producto';
    const price = Number(p.precio ?? it.price);
    const qty = Number(it.qty) || 0;
    const subtotal = Number(it.subtotal);

    return `
      <div class="card" style="display:flex; gap:12px; padding:12px; align-items:center">
        <img src="${img}" alt="${name}" style="width:90px;height:90px;object-fit:cover;border-radius:8px;background:#fafafa">
        <div style="flex:1">
          <div style="font-weight:600">${name}</div>
          <div style="color:#555">${fmt(price)} x ${qty}</div>
          <div style="margin-top:6px"><strong>${fmt(subtotal)}</strong></div>
        </div>
        <div class="row" style="gap:6px">
          <button class="btn outline" onclick="updateQty(${it.product_id || p.id}, ${Math.max(qty-1,0)})">-</button>
          <span style="min-width:28px;text-align:center">${qty}</span>
          <button class="btn outline" onclick="updateQty(${it.product_id || p.id}, ${qty+1})">+</button>
          <button class="btn" style="background:#c0392b" onclick="removeItem(${it.product_id || p.id})">Quitar</button>
        </div>
      </div>
    `;
  }).join('');

  root.innerHTML = `
    <div class="grid" style="grid-template-columns:1fr; gap:12px">
      ${rows}
    </div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:16px">
      <button class="btn outline" onclick="clearCart()">Vaciar carrito</button>
      <div style="font-size:18px">Total: <strong>${fmt(total)}</strong></div>
    </div>
    <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
      <a class="btn outline" href="/products/">Seguir comprando</a>
      <button class="btn" onclick="checkout()">Finalizar compra</button>
    </div>
    <!-- üëâ placeholder para el aviso post-pago -->
    <div id="post-checkout" style="margin-top:14px"></div>    
  `;

  window.GAON_CART?.refresh?.();
}

async function updateQty(product_id, qty){
  if (!Number.isFinite(Number(product_id))) return;
  if (qty <= 0) return removeItem(product_id);
  await api('/api/cart/update/', 'POST', { product_id, qty });
  await loadCart();
}

async function removeItem(product_id){
  await api('/api/cart/remove/', 'POST', { product_id });
  await loadCart();
}

async function clearCart(){
  await api('/api/cart/clear/', 'POST');
  await loadCart();
}

async function checkout(){
  try{
    // 1) Traemos el carrito actual desde la API
    const cart = await api('/api/cart/'); // ya ten√©s api() arriba

    const items = (Array.isArray(cart.items) ? cart.items : [])
      .map(it => {
        const p = it.product || {};
        return {
          product_id: Number(it.product_id || p.id),
          qty: Number(it.qty || 0),
          // opcional: mando nombre/precio para mostrar, pero el backend lo revalida
          title: p.nombre || it.name || 'Producto',
          price: Number(p.precio ?? it.price ?? 0)
        };
      })
      .filter(x => Number.isFinite(x.product_id) && x.qty > 0);

    if (!items.length){
      window.GAON_UI?.toast?.('Tu carrito est√° vac√≠o', 'err');
      return;
    }

    // 2) Creamos la preferencia en el backend pasando los items
    const data = await api('/api/payments/create/', 'POST', { items });

    if (data && data.init_point){
      // actualizar badge si viene la cuenta
      if (typeof data.count === 'number'){
        const badge = document.getElementById('cart-count');
        if (badge){ badge.textContent = String(data.count); badge.style.display = 'inline-block'; }
      }
      // 3) Redirigimos al Checkout Pro
      window.open(data.init_point, '_blank', 'noopener');
      window.GAON_UI?.toast?.('Se abri√≥ Mercado Pago en otra pesta√±a. Volv√© ac√° cuando termines.');

      // pintar el aviso con bot√≥n "Ya pagu√©"
      const pc = document.getElementById('post-checkout');
      if (pc){
        pc.innerHTML = `
          <div class="card" style="padding:12px;border-left:6px solid #16a085">
            <div style="font-weight:600; margin-bottom:6px">¬øTerminaste el pago?</div>
            <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
              <button class="btn" onclick="confirmPayment()">Ya pagu√©</button>
              <a class="btn outline" href="/payments/pending/">Tuve un problema</a>
            </div>
            <small style="color:#555;display:block;margin-top:6px">
              Al confirmar, vaciamos tu carrito y pod√©s seguir comprando.
            </small>
          </div>
        `;
      }
      
      return;
    }

    window.GAON_UI?.toast?.('Respuesta inv√°lida de MP', 'err');
  }catch(e){
    window.GAON_UI?.toast?.('No se pudo iniciar el pago', 'err', String(e));
  }
}

async function confirmPayment(){
  // En este MVP no validamos contra MP; simplemente registramos la compra vaciando el carrito.
  try{
    await api('/api/cart/clear/', 'POST');
    await loadCart();                 // re-render del carrito (mostrar√° "carrito vac√≠o")
    await window.GAON_CART?.refresh?.(); // actualiza el badge del header
    window.GAON_UI?.toast?.('¬°Compra registrada! Gracias por tu pago.');
    // (Opcional) redirigir a una p√°gina de gracias:
    //location.href = '/payments/success/';
  }catch(e){
    window.GAON_UI?.toast?.('No pudimos registrar la compra', 'err', String(e));
  }
}


loadCart();
</script>
{% endblock %}
