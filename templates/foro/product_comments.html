{# Fragmento que se incluye en la ficha de producto para mostrar/crear comentarios #}
<div id="gaon-foro" style="margin-top:20px" data-product-id="{{ p.id }}">
  <h2 style="margin-bottom:8px">Comentarios</h2>

  <div id="foro-list" style="display:flex; flex-direction:column; gap:10px; margin-bottom:8px">
    <small class="text-muted">Cargando comentarios...</small>
  </div>

  {% if request.user.is_authenticated %}
    <div style="display:flex; flex-direction:column; gap:6px; max-width:680px">
      <textarea id="foro-text" rows="3" placeholder="Escribí tu comentario..." style="width:100%;"></textarea>
      <div class="row" style="gap:8px">
        <button class="btn" id="foro-submit">Comentar</button>
      </div>
    </div>
  {% else %}
    <p class="text-muted">Iniciá sesión para comentar.</p>
  {% endif %}

</div>

<script>
(function(){
  const root = document.getElementById('gaon-foro');
  if(!root) return;
  const productId = root.dataset.productId;
  const listEl = document.getElementById('foro-list');
  const textEl = document.getElementById('foro-text');
  const submitEl = document.getElementById('foro-submit');

  function getCsrf(){ const n='csrftoken='; return (document.cookie.split(';').map(c=>c.trim()).find(c=>c.startsWith(n))||'').slice(n.length)||'' }

  async function loadComments(){
    listEl.innerHTML = '<small class="text-muted">Cargando comentarios...</small>';
    try{
      const resp = await fetch(`/api/foro/producto/${productId}/comentarios/`);
      if(!resp.ok) throw new Error('error');
      const data = await resp.json();
      if(!Array.isArray(data) || data.length === 0){
        listEl.innerHTML = '<small class="text-muted">Sin comentarios aún</small>';
        return;
      }
      listEl.innerHTML = '';
      data.forEach(c => {
        const d = document.createElement('div');
        d.className = 'card';
        d.style.padding = '10px';
        d.innerHTML = `<div style="font-size:.9rem; color:#333"><strong>${escapeHtml(c.autor)}</strong> <small class="text-muted" style="font-size:.8rem">${new Date(c.creado_en).toLocaleString()}</small></div><div style="margin-top:6px">${escapeHtml(c.texto)}</div>`;
        listEl.appendChild(d);
      });
    }catch(e){
      listEl.innerHTML = '<small class="text-muted">No se pudieron cargar los comentarios</small>';
      console.error(e);
    }
  }

  function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, function(m){return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m];}); }

  if(submitEl){
    submitEl.addEventListener('click', async function(){
      const txt = (textEl.value||'').trim();
      if(!txt) return window.GAON_UI?.toast?.('Ingresá un comentario');
      try{
        const resp = await fetch(`/api/foro/producto/${productId}/comentarios/`, {
          method: 'POST',
          headers: { 'Content-Type':'application/json', 'X-CSRFToken': getCsrf() },
          body: JSON.stringify({ texto: txt })
        });
        if(!resp.ok){
          window.GAON_UI?.toast?.('No se pudo enviar el comentario');
          return;
        }
        textEl.value = '';
        window.GAON_UI?.toast?.('Comentario publicado');
        await loadComments();
      }catch(e){
        console.error(e); window.GAON_UI?.toast?.('Error al publicar');
      }
    });
  }

  // Cargar al inicio
  loadComments();
})();
</script>
